name: Run xngllamasearch (CPU)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  run:
    runs-on: [self-hosted, linux, x64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare bind-mounts
        run: |
          mkdir -p config data
          chmod -R 775 config data || true

      - name: Stop old container (if any)
        run: docker rm -f xngllamasearch-cont || true

      - name: Pull image
        run: docker pull mrhappynice/bplus-xngllamasearch:latest

      - name: Run container (CPU, no /dev/dri)
        # Keep API keys as secrets; everything else inline as requested
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          docker run --name xngllamasearch-cont -d \
            --restart unless-stopped \
            -p 8080:8080 \
            -p 3001:3001 \
            -v "$PWD/config:/etc/searxng" \
            -v "$PWD/data:/var/cache/searxng" \
            -e INSTANCE_NAME="SearXNG" \
            -e BASE_URL="http://localhost:8080/" \
            -e SEARXNG_URL="http://127.0.0.1:8080" \
            -e AUTH_USERNAME= \
            -e AUTH_PASSWORD= \
            -e OPENAI_API_BASE="http://localhost:1234/v1" \
            -e LMSTUDIO_API_BASE="http://localhost:1234/v1" \
            -e OPENAI_API_KEY="${OPENAI_API_KEY:-}" \
            -e OPENROUTER_API_KEY="${OPENROUTER_API_KEY:-}" \
            -e GOOGLE_API_KEY="${GOOGLE_API_KEY:-}" \
            -e MODEL="bartowski/Llama-3.2-1B-Instruct-GGUF:Q4_K_M" \
            mrhappynice/bplus-xngllamasearch

      - name: Tail logs (first 100 lines)
        run: |
          sleep 3
          docker logs --tail 100 xngllamasearch-cont || true
